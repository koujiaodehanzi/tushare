<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¦‚å¿µè‚¡ç¥¨ç­›é€‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .nav-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }

        .nav-link:hover {
            text-decoration: underline;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .hint {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .btn {
            padding: 12px 32px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 16px;
        }

        .result-section {
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .result-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #667eea;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover {
            background: #f0f0f0;
        }

        .sort-icon {
            font-size: 12px;
            color: #999;
            margin-left: 4px;
        }

        th.sortable.asc .sort-icon::after {
            content: ' â†‘';
            color: #667eea;
        }

        th.sortable.desc .sort-icon::after {
            content: ' â†“';
            color: #667eea;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .stock-code-link {
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
        }

        .stock-code-link:hover {
            color: #764ba2;
        }

        .concepts-cell {
            max-width: 600px;
            word-wrap: break-word;
            font-size: 13px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="nav-link">â† è¿”å›é¦–é¡µ</a>
        
        <h1>ğŸ“Š æ¦‚å¿µè‚¡ç¥¨ç­›é€‰</h1>

        <div class="section">
            <div class="section-title">ç­›é€‰æ¡ä»¶</div>
            
            <div class="form-group">
                <label>åŸºç¡€æ¦‚å¿µï¼ˆè‡³å°‘åŒ…å«å…¶ä¸­ä¸€ä¸ªï¼‰</label>
                <textarea id="baseConcepts" placeholder="æ¯è¡Œä¸€ä¸ªæ¦‚å¿µï¼Œä¾‹å¦‚ï¼š&#10;å•†ä¸šèˆªå¤©&#10;å«æ˜Ÿå¯¼èˆª"></textarea>
                <div class="hint">ä»è¿™äº›æ¦‚å¿µçš„è‚¡ç¥¨ä¸­è¿›è¡Œç­›é€‰ï¼Œå¦‚å¡«å†™äº†è‚¡ç¥¨åç§°åˆ™æ­¤é¡¹å¯ç•™ç©º</div>
            </div>

            <div class="form-group">
                <label>å¿…é¡»åŒ…å«çš„æ¦‚å¿µï¼ˆåŒæ—¶åŒ…å«æ‰€æœ‰ï¼Œæ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼‰</label>
                <textarea id="filterConcepts" placeholder="æ¯è¡Œä¸€ä¸ªå…³é”®è¯ï¼Œä¾‹å¦‚ï¼š&#10;å†›å·¥&#10;èˆªå¤©"></textarea>
                <div class="hint">ç•™ç©ºåˆ™ä¸è¿›è¡ŒäºŒæ¬¡ç­›é€‰ï¼Œæ”¯æŒéƒ¨åˆ†åŒ¹é…ï¼ˆå¦‚"å†›å·¥"å¯åŒ¹é…"å†›å·¥ç”µå­"ï¼‰</div>
            </div>

            <div class="form-group">
                <label>è‚¡ç¥¨åç§°å…³é”®è¯ï¼ˆåŒ…å«ä»»ä¸€å³å¯ï¼Œæ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼‰</label>
                <textarea id="stockNames" placeholder="æ¯è¡Œä¸€ä¸ªå…³é”®è¯ï¼Œä¾‹å¦‚ï¼š&#10;èˆªå¤©&#10;å«æ˜Ÿ"></textarea>
                <div class="hint">ç•™ç©ºåˆ™ä¸æŒ‰åç§°ç­›é€‰ï¼Œæ”¯æŒéƒ¨åˆ†åŒ¹é…ï¼ˆå¦‚"èˆªå¤©"å¯åŒ¹é…"èˆªå¤©å‘å±•"ï¼‰</div>
            </div>

            <button class="btn btn-primary" onclick="filterStocks()">å¼€å§‹ç­›é€‰</button>
            <button class="btn btn-secondary" onclick="loadConceptList()">æŸ¥çœ‹æ‰€æœ‰æ¦‚å¿µ</button>
        </div>

        <div id="loadingSection" class="loading" style="display: none;">
            æ­£åœ¨ç­›é€‰ä¸­ï¼Œè¯·ç¨å€™...
        </div>

        <div id="resultSection" class="section result-section">
            <div class="section-title">ç­›é€‰ç»“æœ</div>
            
            <div class="result-stats">
                <div class="stat-item">
                    <div class="stat-label">ç¬¦åˆæ¡ä»¶è‚¡ç¥¨</div>
                    <div class="stat-value" id="totalStocks">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">åŸºç¡€æ¦‚å¿µ</div>
                    <div class="stat-value" id="baseConceptCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ç­›é€‰æ¦‚å¿µ</div>
                    <div class="stat-value" id="filterConceptCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">åç§°å…³é”®è¯</div>
                    <div class="stat-value" id="stockNameCount">0</div>
                </div>
            </div>

            <div class="table-container">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th>åºå·</th>
                            <th>è‚¡ç¥¨ä»£ç </th>
                            <th class="sortable" onclick="sortTable('name')">è‚¡ç¥¨åç§° <span class="sort-icon">â‡…</span></th>
                            <th class="sortable" onclick="sortTable('pct_1d')">å•æ—¥æ¶¨å¹… <span class="sort-icon">â‡…</span></th>
                            <th class="sortable" onclick="sortTable('pct_9d')">è¿‘9æ—¥æ¶¨å¹… <span class="sort-icon">â‡…</span></th>
                            <th class="sortable" onclick="sortTable('pct_10d')">è¿‘10æ—¥æ¶¨å¹… <span class="sort-icon">â‡…</span></th>
                            <th class="sortable" onclick="sortTable('pct_20d')">è¿‘20æ—¥æ¶¨å¹… <span class="sort-icon">â‡…</span></th>
                            <th class="sortable" onclick="sortTable('pct_29d')">è¿‘29æ—¥æ¶¨å¹… <span class="sort-icon">â‡…</span></th>
                            <th class="sortable" onclick="sortTable('pct_30d')">è¿‘30æ—¥æ¶¨å¹… <span class="sort-icon">â‡…</span></th>
                            <th>æ‰€å±æ¦‚å¿µ</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="conceptListSection" class="section result-section">
            <div class="section-title">æ‰€æœ‰æ¦‚å¿µåˆ—è¡¨</div>
            <div id="conceptList" style="column-count: 4; column-gap: 20px; font-size: 14px; line-height: 2;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5001';
        let currentStocks = [];
        let sortState = { column: null, direction: 'asc' };

        async function filterStocks() {
            const baseConcepts = document.getElementById('baseConcepts').value
                .split('\n')
                .map(s => s.trim())
                .filter(s => s);
            
            const filterConcepts = document.getElementById('filterConcepts').value
                .split('\n')
                .map(s => s.trim())
                .filter(s => s);

            const stockNames = document.getElementById('stockNames').value
                .split('\n')
                .map(s => s.trim())
                .filter(s => s);

            if (baseConcepts.length === 0 && stockNames.length === 0) {
                alert('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªåŸºç¡€æ¦‚å¿µæˆ–è‚¡ç¥¨åç§°');
                return;
            }

            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultSection').classList.remove('show');
            document.getElementById('conceptListSection').classList.remove('show');

            try {
                const response = await fetch(`${API_BASE}/api/concept/filter`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        base_concepts: baseConcepts,
                        filter_concepts: filterConcepts,
                        stock_names: stockNames
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    displayResults(data);
                } else {
                    alert(`ç­›é€‰å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                alert(`è¯·æ±‚å¤±è´¥: ${error.message}`);
            } finally {
                document.getElementById('loadingSection').style.display = 'none';
            }
        }

        function displayResults(data) {
            currentStocks = data.stocks;
            sortState = { column: null, direction: 'asc' };
            
            document.getElementById('totalStocks').textContent = data.total;
            document.getElementById('baseConceptCount').textContent = data.params.base_concepts.length;
            document.getElementById('filterConceptCount').textContent = data.params.filter_concepts.length;
            document.getElementById('stockNameCount').textContent = data.params.stock_names.length;

            renderTable();
            document.getElementById('resultSection').classList.add('show');
        }

        function renderTable() {
            const tbody = document.getElementById('resultBody');
            tbody.innerHTML = currentStocks.map((stock, index) => {
                const pct1d = stock.pct_1d !== null ? stock.pct_1d : '-';
                const pct9d = stock.pct_9d !== null ? stock.pct_9d : '-';
                const pct10d = stock.pct_10d !== null ? stock.pct_10d : '-';
                const pct20d = stock.pct_20d !== null ? stock.pct_20d : '-';
                const pct29d = stock.pct_29d !== null ? stock.pct_29d : '-';
                const pct30d = stock.pct_30d !== null ? stock.pct_30d : '-';
                const color1d = stock.pct_1d > 0 ? '#dc3545' : (stock.pct_1d < 0 ? '#28a745' : '#666');
                const color9d = stock.pct_9d > 0 ? '#dc3545' : (stock.pct_9d < 0 ? '#28a745' : '#666');
                const color10d = stock.pct_10d > 0 ? '#dc3545' : (stock.pct_10d < 0 ? '#28a745' : '#666');
                const color20d = stock.pct_20d > 0 ? '#dc3545' : (stock.pct_20d < 0 ? '#28a745' : '#666');
                const color29d = stock.pct_29d > 0 ? '#dc3545' : (stock.pct_29d < 0 ? '#28a745' : '#666');
                const color30d = stock.pct_30d > 0 ? '#dc3545' : (stock.pct_30d < 0 ? '#28a745' : '#666');
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td><span class="stock-code-link" onclick="window.open('/stock_detail.html?ts_code=${stock.ts_code}', '_blank')">${stock.ts_code}</span></td>
                        <td>${stock.name}</td>
                        <td style="color: ${color1d}; font-weight: 600;">${pct1d}${pct1d !== '-' ? '%' : ''}</td>
                        <td style="color: ${color9d}; font-weight: 600;">${pct9d}${pct9d !== '-' ? '%' : ''}</td>
                        <td style="color: ${color10d}; font-weight: 600;">${pct10d}${pct10d !== '-' ? '%' : ''}</td>
                        <td style="color: ${color20d}; font-weight: 600;">${pct20d}${pct20d !== '-' ? '%' : ''}</td>
                        <td style="color: ${color29d}; font-weight: 600;">${pct29d}${pct29d !== '-' ? '%' : ''}</td>
                        <td style="color: ${color30d}; font-weight: 600;">${pct30d}${pct30d !== '-' ? '%' : ''}</td>
                        <td class="concepts-cell">${stock.concepts}</td>
                    </tr>
                `;
            }).join('');
        }

        function sortTable(column) {
            // Toggle direction if same column, otherwise reset to desc for numbers, asc for name
            if (sortState.column === column) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = column;
                sortState.direction = column === 'name' ? 'asc' : 'desc';
            }

            // Sort the data
            currentStocks.sort((a, b) => {
                let valA, valB;
                
                if (column === 'name') {
                    valA = a.name;
                    valB = b.name;
                    return sortState.direction === 'asc' 
                        ? valA.localeCompare(valB, 'zh-CN')
                        : valB.localeCompare(valA, 'zh-CN');
                } else {
                    valA = a[column] !== null ? a[column] : -Infinity;
                    valB = b[column] !== null ? b[column] : -Infinity;
                    return sortState.direction === 'asc' ? valA - valB : valB - valA;
                }
            });

            // Update sort indicators
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
            });
            event.target.closest('th').classList.add(sortState.direction);

            renderTable();
        }

        async function loadConceptList() {
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultSection').classList.remove('show');
            document.getElementById('conceptListSection').classList.remove('show');

            try {
                const response = await fetch(`${API_BASE}/api/concept/list`);
                const data = await response.json();

                if (response.ok) {
                    const conceptList = document.getElementById('conceptList');
                    conceptList.innerHTML = data.concepts.map(c => `<div>â€¢ ${c}</div>`).join('');
                    document.getElementById('conceptListSection').classList.add('show');
                } else {
                    alert(`è·å–æ¦‚å¿µåˆ—è¡¨å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                alert(`è¯·æ±‚å¤±è´¥: ${error.message}`);
            } finally {
                document.getElementById('loadingSection').style.display = 'none';
            }
        }
    </script>
</body>
</html>
