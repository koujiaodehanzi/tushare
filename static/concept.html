<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¦‚å¿µè‚¡ç¥¨ç­›é€‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .nav-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }

        .nav-link:hover {
            text-decoration: underline;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .hint {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .btn {
            padding: 12px 32px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 16px;
        }

        .result-section {
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .result-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #667eea;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover {
            background: #f0f0f0;
        }

        .sort-icon {
            font-size: 12px;
            color: #999;
            margin-left: 4px;
        }

        th.sortable.asc .sort-icon::after {
            content: ' â†‘';
            color: #667eea;
        }

        th.sortable.desc .sort-icon::after {
            content: ' â†“';
            color: #667eea;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .stock-code-link {
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
        }

        .stock-code-link:hover {
            color: #764ba2;
        }

        .concepts-cell {
            max-width: 600px;
            word-wrap: break-word;
            font-size: 13px;
            color: #666;
            position: relative;
        }

        /* æ¦‚å¿µåˆ†ææµ®åŠ¨é¢æ¿ */
        .concept-panel {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 20px;
            max-width: 600px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .concept-panel.show {
            display: block;
        }

        .concept-panel-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            filter: drop-shadow(0 0 2px rgba(0,0,0,0.1));
        }

        .concept-panel-arrow.left {
            left: -20px;
            border-right-color: white;
        }

        .concept-panel-arrow.right {
            right: -20px;
            border-left-color: white;
        }

        .concept-panel-arrow.top {
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            border-bottom-color: white;
        }

        .concept-panel-arrow.bottom {
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            border-top-color: white;
        }

        .concept-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            cursor: move;
            user-select: none;
        }

        .concept-panel-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .concept-panel-close {
            cursor: pointer;
            font-size: 20px;
            color: #999;
            line-height: 1;
        }

        .concept-panel-close:hover {
            color: #333;
        }

        .concept-panel-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .concept-panel-btn {
            margin-top: 15px;
            padding: 10px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .concept-panel-btn:hover {
            background: #5568d3;
        }

        .concept-panel-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .concept-analysis-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .concept-analysis-table th,
        .concept-analysis-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        .concept-analysis-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .concept-analysis-table tr:hover {
            background: #f8f9fa;
        }

        .relevance-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .relevance-bar-bg {
            flex: 1;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        .relevance-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .relevance-bar-text {
            font-weight: 600;
            min-width: 40px;
        }

        .loading-spinner {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #eee;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            animation: progress 2s ease-in-out infinite;
        }

        @keyframes progress {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }

        /* æ‰¹é‡å¤„ç†è¿›åº¦å¼¹çª— */
        .batch-progress-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            padding: 30px;
            min-width: 400px;
            z-index: 2000;
            display: none;
        }

        .batch-progress-modal.show {
            display: block;
        }

        .batch-progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }

        .batch-progress-overlay.show {
            display: block;
        }

        .batch-progress-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .batch-progress-bar {
            width: 100%;
            height: 20px;
            background: #eee;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .batch-progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }

        .batch-progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- æ‰¹é‡å¤„ç†è¿›åº¦å¼¹çª— -->
    <div class="batch-progress-overlay" id="batchProgressOverlay"></div>
    <div class="batch-progress-modal" id="batchProgressModal">
        <div class="batch-progress-title">æ‰¹é‡è·å–æ¦‚å¿µåˆ†æ</div>
        <div class="batch-progress-bar">
            <div class="batch-progress-bar-fill" id="batchProgressFill" style="width: 0%"></div>
        </div>
        <div class="batch-progress-text" id="batchProgressText">å‡†å¤‡ä¸­...</div>
    </div>

    <!-- æ¦‚å¿µåˆ†ææµ®åŠ¨é¢æ¿ -->
    <div id="conceptPanel" class="concept-panel">
        <div class="concept-panel-arrow left"></div>
        <div class="concept-panel-header">
            <div class="concept-panel-title" id="panelTitle">æ¦‚å¿µå…³è”åˆ†æ</div>
            <div class="concept-panel-close" onclick="closeConceptPanel()">Ã—</div>
        </div>
        <div id="panelContent"></div>
    </div>

    <div class="container">
        <a href="/" class="nav-link">â† è¿”å›é¦–é¡µ</a>
        
        <h1>ğŸ“Š æ¦‚å¿µè‚¡ç¥¨ç­›é€‰</h1>

        <div class="section">
            <div class="section-title">ç­›é€‰æ¡ä»¶</div>
            
            <div class="form-group">
                <label>åŸºç¡€æ¦‚å¿µï¼ˆè‡³å°‘åŒ…å«å…¶ä¸­ä¸€ä¸ªï¼‰</label>
                <textarea id="baseConcepts" placeholder="æ¯è¡Œä¸€ä¸ªæ¦‚å¿µï¼Œä¾‹å¦‚ï¼š&#10;å•†ä¸šèˆªå¤©&#10;å«æ˜Ÿå¯¼èˆª"></textarea>
                <div class="hint">ä»è¿™äº›æ¦‚å¿µçš„è‚¡ç¥¨ä¸­è¿›è¡Œç­›é€‰ï¼Œå¦‚å¡«å†™äº†è‚¡ç¥¨åç§°åˆ™æ­¤é¡¹å¯ç•™ç©º</div>
            </div>

            <div class="form-group">
                <label>å¿…é¡»åŒ…å«çš„æ¦‚å¿µï¼ˆåŒæ—¶åŒ…å«æ‰€æœ‰ï¼Œæ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼‰</label>
                <textarea id="filterConcepts" placeholder="æ¯è¡Œä¸€ä¸ªå…³é”®è¯ï¼Œä¾‹å¦‚ï¼š&#10;å†›å·¥&#10;èˆªå¤©"></textarea>
                <div class="hint">ç•™ç©ºåˆ™ä¸è¿›è¡ŒäºŒæ¬¡ç­›é€‰ï¼Œæ”¯æŒéƒ¨åˆ†åŒ¹é…ï¼ˆå¦‚"å†›å·¥"å¯åŒ¹é…"å†›å·¥ç”µå­"ï¼‰</div>
            </div>

            <div class="form-group">
                <label>è‚¡ç¥¨åç§°å…³é”®è¯ï¼ˆåŒ…å«ä»»ä¸€å³å¯ï¼Œæ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼‰</label>
                <textarea id="stockNames" placeholder="æ¯è¡Œä¸€ä¸ªå…³é”®è¯ï¼Œä¾‹å¦‚ï¼š&#10;èˆªå¤©&#10;å«æ˜Ÿ"></textarea>
                <div class="hint">ç•™ç©ºåˆ™ä¸æŒ‰åç§°ç­›é€‰ï¼Œæ”¯æŒéƒ¨åˆ†åŒ¹é…ï¼ˆå¦‚"èˆªå¤©"å¯åŒ¹é…"èˆªå¤©å‘å±•"ï¼‰</div>
            </div>

            <button class="btn btn-primary" onclick="filterStocks()">å¼€å§‹ç­›é€‰</button>
            <button class="btn btn-secondary" onclick="loadConceptList()">æŸ¥çœ‹æ‰€æœ‰æ¦‚å¿µ</button>
        </div>

        <div id="loadingSection" class="loading" style="display: none;">
            æ­£åœ¨ç­›é€‰ä¸­ï¼Œè¯·ç¨å€™...
        </div>

        <div id="resultSection" class="section result-section">
            <div class="section-title">ç­›é€‰ç»“æœ</div>
            
            <div class="result-stats">
                <div class="stat-item">
                    <div class="stat-label">ç¬¦åˆæ¡ä»¶è‚¡ç¥¨</div>
                    <div class="stat-value" id="totalStocks">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">åŸºç¡€æ¦‚å¿µ</div>
                    <div class="stat-value" id="baseConceptCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ç­›é€‰æ¦‚å¿µ</div>
                    <div class="stat-value" id="filterConceptCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">åç§°å…³é”®è¯</div>
                    <div class="stat-value" id="stockNameCount">0</div>
                </div>
            </div>

            <div class="table-container">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th>åºå·</th>
                            <th>è‚¡ç¥¨ä»£ç </th>
                            <th class="sortable" onclick="sortTable('name')">è‚¡ç¥¨åç§° <span class="sort-icon">â‡…</span></th>
                            <th class="sortable" onclick="sortTable('pct_1d')">å•æ—¥æ¶¨å¹… <span class="sort-icon">â‡…</span></th>
                            <th class="sortable" onclick="sortTable('pct_9d')">è¿‘9æ—¥æ¶¨å¹… <span class="sort-icon">â‡…</span></th>
                            <th class="sortable" onclick="sortTable('pct_10d')">è¿‘10æ—¥æ¶¨å¹… <span class="sort-icon">â‡…</span></th>
                            <th class="sortable" onclick="sortTable('pct_20d')">è¿‘20æ—¥æ¶¨å¹… <span class="sort-icon">â‡…</span></th>
                            <th class="sortable" onclick="sortTable('pct_29d')">è¿‘29æ—¥æ¶¨å¹… <span class="sort-icon">â‡…</span></th>
                            <th class="sortable" onclick="sortTable('pct_30d')">è¿‘30æ—¥æ¶¨å¹… <span class="sort-icon">â‡…</span></th>
                            <th>
                                æ‰€å±æ¦‚å¿µ
                                <button class="concept-panel-btn" style="padding: 4px 8px; font-size: 11px; margin-left: 8px;" onclick="event.stopPropagation(); batchGenerateAnalysis()">ğŸ“Š æ‰¹é‡è·å–</button>
                                <button class="concept-panel-btn" style="padding: 4px 8px; font-size: 11px; margin-left: 4px; background: #dc3545;" onclick="event.stopPropagation(); batchDeleteAnalysis()">ğŸ—‘ï¸ æ¸…ç†æ•°æ®</button>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="resultBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="conceptListSection" class="section result-section">
            <div class="section-title">æ‰€æœ‰æ¦‚å¿µåˆ—è¡¨</div>
            <div id="conceptList" style="column-count: 4; column-gap: 20px; font-size: 14px; line-height: 2;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5001';
        let currentStocks = [];
        let sortState = { column: null, direction: 'asc' };
        let currentFilterParams = { base_concepts: [], filter_concepts: [] }; // ä¿å­˜ç­›é€‰å‚æ•°

        async function filterStocks() {
            const baseConcepts = document.getElementById('baseConcepts').value
                .split('\n')
                .map(s => s.trim())
                .filter(s => s);
            
            const filterConcepts = document.getElementById('filterConcepts').value
                .split('\n')
                .map(s => s.trim())
                .filter(s => s);

            const stockNames = document.getElementById('stockNames').value
                .split('\n')
                .map(s => s.trim())
                .filter(s => s);

            if (baseConcepts.length === 0 && stockNames.length === 0) {
                alert('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªåŸºç¡€æ¦‚å¿µæˆ–è‚¡ç¥¨åç§°');
                return;
            }

            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultSection').classList.remove('show');
            document.getElementById('conceptListSection').classList.remove('show');

            try {
                const response = await fetch(`${API_BASE}/api/concept/filter`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        base_concepts: baseConcepts,
                        filter_concepts: filterConcepts,
                        stock_names: stockNames
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    displayResults(data);
                } else {
                    alert(`ç­›é€‰å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                alert(`è¯·æ±‚å¤±è´¥: ${error.message}`);
            } finally {
                document.getElementById('loadingSection').style.display = 'none';
            }
        }

        function displayResults(data) {
            currentStocks = data.stocks;
            sortState = { column: null, direction: 'asc' };
            
            // ä¿å­˜ç­›é€‰å‚æ•°
            currentFilterParams = {
                base_concepts: data.params.base_concepts || [],
                filter_concepts: data.params.filter_concepts || []
            };
            
            document.getElementById('totalStocks').textContent = data.total;
            document.getElementById('baseConceptCount').textContent = data.params.base_concepts.length;
            document.getElementById('filterConceptCount').textContent = data.params.filter_concepts.length;
            document.getElementById('stockNameCount').textContent = data.params.stock_names.length;

            renderTable();
            document.getElementById('resultSection').classList.add('show');
        }

        function renderTable() {
            const tbody = document.getElementById('resultBody');
            const thead = document.querySelector('#resultTable thead tr');
            const hasBaseConcepts = currentFilterParams.base_concepts && currentFilterParams.base_concepts.length > 0;
            
            // åŠ¨æ€æ›´æ–°è¡¨å¤´
            const conceptsHeader = thead.querySelector('th:last-child');
            const baseScoreHeader = thead.querySelector('.base-score-header');
            
            if (hasBaseConcepts && !baseScoreHeader) {
                // æ·»åŠ åŸºç¡€æ¦‚å¿µå…³è”åº¦åˆ—
                const newHeader = document.createElement('th');
                newHeader.className = 'sortable base-score-header';
                newHeader.onclick = () => sortTable('base_concept_score');
                newHeader.innerHTML = 'åŸºç¡€æ¦‚å¿µå…³è”åº¦ <span class="sort-icon">â‡…</span>';
                conceptsHeader.parentNode.insertBefore(newHeader, conceptsHeader);
            } else if (!hasBaseConcepts && baseScoreHeader) {
                // ç§»é™¤åŸºç¡€æ¦‚å¿µå…³è”åº¦åˆ—
                baseScoreHeader.remove();
            }
            
            tbody.innerHTML = currentStocks.map((stock, index) => {
                const pct1d = stock.pct_1d !== null ? stock.pct_1d : '-';
                const pct9d = stock.pct_9d !== null ? stock.pct_9d : '-';
                const pct10d = stock.pct_10d !== null ? stock.pct_10d : '-';
                const pct20d = stock.pct_20d !== null ? stock.pct_20d : '-';
                const pct29d = stock.pct_29d !== null ? stock.pct_29d : '-';
                const pct30d = stock.pct_30d !== null ? stock.pct_30d : '-';
                const color1d = stock.pct_1d > 0 ? '#dc3545' : (stock.pct_1d < 0 ? '#28a745' : '#666');
                const color9d = stock.pct_9d > 0 ? '#dc3545' : (stock.pct_9d < 0 ? '#28a745' : '#666');
                const color10d = stock.pct_10d > 0 ? '#dc3545' : (stock.pct_10d < 0 ? '#28a745' : '#666');
                const color20d = stock.pct_20d > 0 ? '#dc3545' : (stock.pct_20d < 0 ? '#28a745' : '#666');
                const color29d = stock.pct_29d > 0 ? '#dc3545' : (stock.pct_29d < 0 ? '#28a745' : '#666');
                const color30d = stock.pct_30d > 0 ? '#dc3545' : (stock.pct_30d < 0 ? '#28a745' : '#666');
                
                // åŸºç¡€æ¦‚å¿µå…³è”åº¦
                const baseScore = stock.base_concept_score !== null && stock.base_concept_score !== undefined ? stock.base_concept_score : '-';
                const baseScoreColor = stock.base_concept_score >= 70 ? '#28a745' : (stock.base_concept_score >= 50 ? '#ffc107' : '#dc3545');
                const baseScoreCell = hasBaseConcepts ? `<td style="color: ${baseScoreColor}; font-weight: 600;">${baseScore}${baseScore !== '-' ? 'åˆ†' : ''}</td>` : '';
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td><span class="stock-code-link" onclick="window.open('/stock_detail.html?ts_code=${stock.ts_code}', '_blank')">${stock.ts_code}</span></td>
                        <td>${stock.name}</td>
                        <td style="color: ${color1d}; font-weight: 600;">${pct1d}${pct1d !== '-' ? '%' : ''}</td>
                        <td style="color: ${color9d}; font-weight: 600;">${pct9d}${pct9d !== '-' ? '%' : ''}</td>
                        <td style="color: ${color10d}; font-weight: 600;">${pct10d}${pct10d !== '-' ? '%' : ''}</td>
                        <td style="color: ${color20d}; font-weight: 600;">${pct20d}${pct20d !== '-' ? '%' : ''}</td>
                        <td style="color: ${color29d}; font-weight: 600;">${pct29d}${pct29d !== '-' ? '%' : ''}</td>
                        <td style="color: ${color30d}; font-weight: 600;">${pct30d}${pct30d !== '-' ? '%' : ''}</td>
                        ${baseScoreCell}
                        <td class="concepts-cell" onclick="showConceptAnalysis(event, '${stock.ts_code}', '${stock.name}', '${stock.concepts}')" style="cursor: pointer; color: #667eea;">${stock.concepts}</td>
                    </tr>
                `;
            }).join('');
        }

        function sortTable(column) {
            // Toggle direction if same column, otherwise reset to desc for numbers, asc for name
            if (sortState.column === column) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = column;
                sortState.direction = column === 'name' ? 'asc' : 'desc';
            }

            // Sort the data
            currentStocks.sort((a, b) => {
                let valA, valB;
                
                if (column === 'name') {
                    valA = a.name;
                    valB = b.name;
                    return sortState.direction === 'asc' 
                        ? valA.localeCompare(valB, 'zh-CN')
                        : valB.localeCompare(valA, 'zh-CN');
                } else {
                    valA = a[column] !== null ? a[column] : -Infinity;
                    valB = b[column] !== null ? b[column] : -Infinity;
                    return sortState.direction === 'asc' ? valA - valB : valB - valA;
                }
            });

            // Update sort indicators
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
            });
            event.target.closest('th').classList.add(sortState.direction);

            renderTable();
        }

        async function loadConceptList() {
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultSection').classList.remove('show');
            document.getElementById('conceptListSection').classList.remove('show');

            try {
                const response = await fetch(`${API_BASE}/api/concept/list`);
                const data = await response.json();

                if (response.ok) {
                    const conceptList = document.getElementById('conceptList');
                    conceptList.innerHTML = data.concepts.map(c => `<div>â€¢ ${c}</div>`).join('');
                    document.getElementById('conceptListSection').classList.add('show');
                } else {
                    alert(`è·å–æ¦‚å¿µåˆ—è¡¨å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                alert(`è¯·æ±‚å¤±è´¥: ${error.message}`);
            } finally {
                document.getElementById('loadingSection').style.display = 'none';
            }
        }

        // æ¦‚å¿µåˆ†æç›¸å…³å‡½æ•°
        let currentAnalysisStock = null;

        function showConceptAnalysis(event, tsCode, stockName, conceptsStr) {
            event.stopPropagation();
            
            currentAnalysisStock = {
                ts_code: tsCode,
                stock_name: stockName,
                concepts: conceptsStr.split(', ')
            };

            const panel = document.getElementById('conceptPanel');
            const arrow = panel.querySelector('.concept-panel-arrow');
            const rect = event.target.getBoundingClientRect();
            
            // é‡ç½®ç®­å¤´ç±»å
            arrow.className = 'concept-panel-arrow';
            
            // è®¡ç®—é¢æ¿ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºå±å¹•
            let left = rect.right + 20;
            let top = rect.top;
            let arrowDirection = 'left';
            let arrowTop = rect.top + rect.height / 2;
            
            // å¦‚æœå³ä¾§ç©ºé—´ä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨å·¦ä¾§
            if (left + 600 > window.innerWidth) {
                left = rect.left - 620;
                arrowDirection = 'right';
                
                // å¦‚æœå·¦ä¾§ä¹Ÿä¸å¤Ÿï¼Œå±…ä¸­æ˜¾ç¤º
                if (left < 0) {
                    left = (window.innerWidth - 600) / 2;
                    top = rect.bottom + 20;
                    arrowDirection = 'top';
                    arrowTop = null;
                }
            }
            
            // å¦‚æœä¸‹æ–¹ç©ºé—´ä¸å¤Ÿï¼Œå‘ä¸Šè°ƒæ•´
            if (top + 500 > window.innerHeight) {
                top = Math.max(20, window.innerHeight - 520);
            }
            
            panel.style.left = left + 'px';
            panel.style.top = top + 'px';
            
            // è®¾ç½®ç®­å¤´æ–¹å‘å’Œä½ç½®
            arrow.classList.add(arrowDirection);
            if (arrowTop !== null && (arrowDirection === 'left' || arrowDirection === 'right')) {
                arrow.style.top = (arrowTop - top) + 'px';
            } else {
                arrow.style.top = '';
            }
            
            // æ˜¾ç¤ºé¢æ¿
            panel.classList.add('show');
            document.getElementById('panelTitle').textContent = `${stockName} - æ¦‚å¿µå…³è”åˆ†æ`;
            
            // åŠ è½½æ•°æ®
            loadConceptAnalysis(tsCode);
        }

        function closeConceptPanel() {
            document.getElementById('conceptPanel').classList.remove('show');
            currentAnalysisStock = null;
        }

        async function loadConceptAnalysis(tsCode) {
            const content = document.getElementById('panelContent');
            content.innerHTML = '<div class="loading-spinner">åŠ è½½ä¸­...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/concept/analysis?ts_code=${tsCode}`);
                const result = await response.json();
                
                if (response.ok) {
                    if (result.has_data) {
                        renderAnalysisTable(result.data);
                    } else {
                        renderEmptyState();
                    }
                } else {
                    content.innerHTML = `<div class="concept-panel-empty">åŠ è½½å¤±è´¥: ${result.error}</div>`;
                }
            } catch (error) {
                content.innerHTML = `<div class="concept-panel-empty">è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        function renderEmptyState() {
            const content = document.getElementById('panelContent');
            content.innerHTML = `
                <div class="concept-panel-empty">
                    <div>æš‚æ— æ¦‚å¿µåˆ†ææ•°æ®</div>
                    <button class="concept-panel-btn" onclick="event.stopPropagation(); generateAnalysis()">è·å–æ•°æ®</button>
                </div>
            `;
        }

        function renderAnalysisTable(data) {
            const content = document.getElementById('panelContent');
            
            // å¦‚æœæœ‰ç­›é€‰å‚æ•°ï¼Œå¯¹æ•°æ®è¿›è¡Œæ’åº
            let sortedData = [...data];
            if (currentFilterParams.base_concepts.length > 0 || currentFilterParams.filter_concepts.length > 0) {
                const priorityConcepts = [...currentFilterParams.base_concepts, ...currentFilterParams.filter_concepts];
                
                sortedData.sort((a, b) => {
                    const aIsPriority = priorityConcepts.includes(a.concept);
                    const bIsPriority = priorityConcepts.includes(b.concept);
                    
                    if (aIsPriority && !bIsPriority) return -1;
                    if (!aIsPriority && bIsPriority) return 1;
                    
                    // éƒ½æ˜¯ä¼˜å…ˆæˆ–éƒ½ä¸æ˜¯ä¼˜å…ˆï¼ŒæŒ‰å…³è”åº¦æ’åº
                    return b.score - a.score;
                });
            }
            
            const rows = sortedData.map(item => {
                const color = item.score >= 70 ? '#28a745' : (item.score >= 50 ? '#ffc107' : '#dc3545');
                return `
                    <tr>
                        <td>${item.concept}</td>
                        <td>
                            <div class="relevance-bar">
                                <div class="relevance-bar-bg">
                                    <div class="relevance-bar-fill" style="width: ${item.score}%; background: ${color};"></div>
                                </div>
                                <div class="relevance-bar-text" style="color: ${color};">${item.score}%</div>
                            </div>
                        </td>
                        <td>${item.description}</td>
                        <td>${item.evidence}</td>
                    </tr>
                `;
            }).join('');
            
            content.innerHTML = `
                <div style="text-align: right; margin-bottom: 10px;">
                    <button class="concept-panel-btn" style="padding: 6px 12px; font-size: 12px; background: #ffc107;" onclick="event.stopPropagation(); refreshAnalysis()">ğŸ”„ é‡æ–°è·å–</button>
                </div>
                <table class="concept-analysis-table">
                    <thead>
                        <tr>
                            <th>æ¦‚å¿µ</th>
                            <th style="width: 150px;">å…³è”åº¦</th>
                            <th>å…³è”æ€§è¯´æ˜</th>
                            <th>å…·ä½“äº‹é¡¹</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
        }

        async function generateAnalysis() {
            if (!currentAnalysisStock) return;
            
            const content = document.getElementById('panelContent');
            
            // æ˜¾ç¤ºè¯¦ç»†çš„åŠ è½½çŠ¶æ€
            content.innerHTML = `
                <div class="loading-spinner">
                    <div style="font-size: 16px; margin-bottom: 10px;">ğŸ¤– æ­£åœ¨è°ƒç”¨å¤§æ¨¡å‹åˆ†æ...</div>
                    <div style="font-size: 14px; color: #999;">
                        <div>â€¢ åˆ†æè‚¡ç¥¨: ${currentAnalysisStock.stock_name}</div>
                        <div>â€¢ æ¦‚å¿µæ•°é‡: ${currentAnalysisStock.concepts.length} ä¸ª</div>
                        <div>â€¢ é¢„è®¡è€—æ—¶: 10-30ç§’</div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="progress-bar">
                            <div class="progress-bar-fill"></div>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/api/concept/analysis`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(currentAnalysisStock)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    renderAnalysisTable(result.data);
                } else {
                    content.innerHTML = `
                        <div class="concept-panel-empty">
                            <div style="color: #dc3545; margin-bottom: 10px;">âŒ ç”Ÿæˆå¤±è´¥</div>
                            <div style="font-size: 13px; color: #666;">${result.error}</div>
                            <button class="concept-panel-btn" onclick="event.stopPropagation(); generateAnalysis()">é‡è¯•</button>
                        </div>
                    `;
                }
            } catch (error) {
                content.innerHTML = `
                    <div class="concept-panel-empty">
                        <div style="color: #dc3545; margin-bottom: 10px;">âŒ è¯·æ±‚å¤±è´¥</div>
                        <div style="font-size: 13px; color: #666;">${error.message}</div>
                        <button class="concept-panel-btn" onclick="event.stopPropagation(); generateAnalysis()">é‡è¯•</button>
                    </div>
                `;
            }
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­é¢æ¿
        document.addEventListener('click', function(event) {
            const panel = document.getElementById('conceptPanel');
            if (panel.classList.contains('show') && !panel.contains(event.target)) {
                const conceptsCells = document.querySelectorAll('.concepts-cell');
                let clickedConceptCell = false;
                conceptsCells.forEach(cell => {
                    if (cell.contains(event.target)) {
                        clickedConceptCell = true;
                    }
                });
                if (!clickedConceptCell) {
                    closeConceptPanel();
                }
            }
        });

        async function refreshAnalysis() {
            if (!currentAnalysisStock) return;
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤ç°æœ‰æ•°æ®å¹¶é‡æ–°è·å–å—ï¼Ÿ')) {
                return;
            }
            
            const content = document.getElementById('panelContent');
            content.innerHTML = '<div class="loading-spinner">æ­£åœ¨åˆ é™¤æ—§æ•°æ®...</div>';
            
            try {
                // åˆ é™¤æ—§æ•°æ®
                const deleteResponse = await fetch(`${API_BASE}/api/concept/analysis?ts_code=${currentAnalysisStock.ts_code}`, {
                    method: 'DELETE'
                });
                
                if (!deleteResponse.ok) {
                    throw new Error('åˆ é™¤æ•°æ®å¤±è´¥');
                }
                
                // é‡æ–°ç”Ÿæˆ
                await generateAnalysis();
                
            } catch (error) {
                content.innerHTML = `
                    <div class="concept-panel-empty">
                        <div style="color: #dc3545; margin-bottom: 10px;">âŒ åˆ·æ–°å¤±è´¥</div>
                        <div style="font-size: 13px; color: #666;">${error.message}</div>
                        <button class="concept-panel-btn" onclick="event.stopPropagation(); refreshAnalysis()">é‡è¯•</button>
                    </div>
                `;
            }
        }

        // å¼¹çª—æ‹–åŠ¨åŠŸèƒ½
        let isDragging = false;
        let dragStartX, dragStartY, panelStartX, panelStartY;

        document.addEventListener('DOMContentLoaded', function() {
            const panel = document.getElementById('conceptPanel');
            const header = panel.querySelector('.concept-panel-header');

            header.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('concept-panel-close')) return;
                
                isDragging = true;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                panelStartX = parseInt(panel.style.left) || 0;
                panelStartY = parseInt(panel.style.top) || 0;
                
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;
                
                panel.style.left = (panelStartX + deltaX) + 'px';
                panel.style.top = (panelStartY + deltaY) + 'px';
            });

            document.addEventListener('mouseup', function() {
                isDragging = false;
                document.body.style.userSelect = '';
            });
        });

        // æ‰¹é‡è·å–æ‰€æœ‰è‚¡ç¥¨çš„æ¦‚å¿µåˆ†æ
        async function batchGenerateAnalysis() {
            if (!currentStocks || currentStocks.length === 0) {
                alert('è¯·å…ˆç­›é€‰è‚¡ç¥¨');
                return;
            }

            if (!confirm(`ç¡®å®šè¦ä¸º ${currentStocks.length} åªè‚¡ç¥¨æ‰¹é‡è·å–æ¦‚å¿µåˆ†æå—ï¼Ÿ\nè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ã€‚`)) {
                return;
            }

            const modal = document.getElementById('batchProgressModal');
            const overlay = document.getElementById('batchProgressOverlay');
            const fill = document.getElementById('batchProgressFill');
            const text = document.getElementById('batchProgressText');

            modal.classList.add('show');
            overlay.classList.add('show');

            const total = currentStocks.length;
            let completed = 0;
            let success = 0;
            let failed = 0;
            let skipped = 0;

            // ä¸²è¡Œå¤„ç†ï¼ˆé€ä¸ªå¤„ç†ï¼‰ï¼Œæ¯æ¬¡è¯·æ±‚é—´éš”3ç§’
            for (let i = 0; i < total; i++) {
                const stock = currentStocks[i];
                
                try {
                    // å…ˆæ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®
                    const checkResponse = await fetch(`${API_BASE}/api/concept/analysis?ts_code=${stock.ts_code}`);
                    const checkResult = await checkResponse.json();
                    
                    if (checkResult.has_data) {
                        // å·²æœ‰æ•°æ®ï¼Œè·³è¿‡
                        skipped++;
                    } else {
                        // æ²¡æœ‰æ•°æ®ï¼Œè°ƒç”¨ç”Ÿæˆ
                        const response = await fetch(`${API_BASE}/api/concept/analysis`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                ts_code: stock.ts_code,
                                stock_name: stock.name,
                                concepts: stock.concepts.split(', ')
                            })
                        });

                        if (response.ok) {
                            success++;
                        } else {
                            failed++;
                        }
                        
                        // æˆåŠŸæˆ–å¤±è´¥åéƒ½ç­‰å¾…3ç§’ï¼Œé¿å…è¯·æ±‚è¿‡å¿«
                        if (i < total - 1) {
                            await new Promise(resolve => setTimeout(resolve, 3000));
                        }
                    }
                } catch (error) {
                    failed++;
                } finally {
                    completed++;
                    const progress = Math.round((completed / total) * 100);
                    fill.style.width = progress + '%';
                    text.textContent = `è¿›åº¦: ${completed}/${total} (æˆåŠŸ: ${success}, è·³è¿‡: ${skipped}, å¤±è´¥: ${failed})`;
                }
            }

            text.textContent = `å®Œæˆ! æ€»è®¡: ${total}, æˆåŠŸ: ${success}, è·³è¿‡: ${skipped}, å¤±è´¥: ${failed}`;
            
            setTimeout(() => {
                modal.classList.remove('show');
                overlay.classList.remove('show');
                alert(`æ‰¹é‡å¤„ç†å®Œæˆ!\næˆåŠŸ: ${success}\nè·³è¿‡(å·²æœ‰æ•°æ®): ${skipped}\nå¤±è´¥: ${failed}`);
            }, 2000);
        }

        // æ‰¹é‡åˆ é™¤æ‰€æœ‰è‚¡ç¥¨çš„æ¦‚å¿µåˆ†ææ•°æ®
        async function batchDeleteAnalysis() {
            if (!currentStocks || currentStocks.length === 0) {
                alert('è¯·å…ˆç­›é€‰è‚¡ç¥¨');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${currentStocks.length} åªè‚¡ç¥¨çš„æ¦‚å¿µåˆ†ææ•°æ®å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            const modal = document.getElementById('batchProgressModal');
            const overlay = document.getElementById('batchProgressOverlay');
            const fill = document.getElementById('batchProgressFill');
            const text = document.getElementById('batchProgressText');

            modal.classList.add('show');
            overlay.classList.add('show');

            const total = currentStocks.length;
            let completed = 0;
            let success = 0;
            let failed = 0;
            const concurrency = 5; // åˆ é™¤æ“ä½œå¯ä»¥æ›´å¿«

            // åˆ†æ‰¹å¤„ç†
            for (let i = 0; i < total; i += concurrency) {
                const batch = currentStocks.slice(i, Math.min(i + concurrency, total));
                
                await Promise.all(batch.map(async (stock) => {
                    try {
                        const response = await fetch(`${API_BASE}/api/concept/analysis?ts_code=${stock.ts_code}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            success++;
                        } else {
                            failed++;
                        }
                    } catch (error) {
                        failed++;
                    } finally {
                        completed++;
                        const progress = Math.round((completed / total) * 100);
                        fill.style.width = progress + '%';
                        text.textContent = `åˆ é™¤è¿›åº¦: ${completed}/${total} (æˆåŠŸ: ${success}, å¤±è´¥: ${failed})`;
                    }
                }));
            }

            text.textContent = `åˆ é™¤å®Œæˆ! æ€»è®¡: ${total}, æˆåŠŸ: ${success}, å¤±è´¥: ${failed}`;
            
            setTimeout(() => {
                modal.classList.remove('show');
                overlay.classList.remove('show');
                alert(`æ‰¹é‡åˆ é™¤å®Œæˆ!\næˆåŠŸ: ${success}\nå¤±è´¥: ${failed}`);
            }, 2000);
        }
    </script>
</body>
</html>
